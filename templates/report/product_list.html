{% extends 'base.html' %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-4">匯率報表</h2>

  <!-- 日期 + 幣別 + 分組依據搜尋表單 -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">開始日期</label>
      <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">結束日期</label>
      <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">幣別</label>
      <select name="currency" class="form-select">
        <option value="">全部</option>
        {% for c in currency_options %}
          <option value="{{ c }}" {% if request.GET.currency == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">分組依據</label>
      <select name="group_by" class="form-select">
        <option value="day" {% if request.GET.group_by == 'day' %}selected{% endif %}>日</option>
        <option value="month" {% if request.GET.group_by == 'month' or not request.GET.group_by %}selected{% endif %}>月</option>
        <option value="year" {% if request.GET.group_by == 'year' %}selected{% endif %}>年</option>
      </select>
    </div>
    <div class="col-md-12 d-flex justify-content-end">
      <button type="submit" class="btn btn-primary">搜尋</button>
    </div>
  </form>

  <!-- 匯出按鈕 -->
  <div class="mb-3">
    <a href="{% url 'report_csv' %}?start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&currency={{ request.GET.currency }}&group_by={{ request.GET.group_by }}" class="btn btn-success me-2">匯出 CSV</a>
    <a href="{% url 'report_excel' %}?start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&currency={{ request.GET.currency }}&group_by={{ request.GET.group_by }}" class="btn btn-warning">匯出 Excel</a>
  </div>



  <!-- 資料表格 -->
  <table class="table table-striped mt-4">
    <thead>
      <tr>
        <th>幣別</th>
        <th>現金買入</th>
        <th>現金賣出</th>
        <th>日期</th>
      </tr>
    </thead>
    <tbody>
      {% for product in products %}
      <tr>
        <td>{{ product.currency }}</td>
        <td>{{ product.cash_buy }}</td>
        <td>{{ product.cash_sell }}</td>
        <td>{{ product.date|date:"Y-m-d" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="4">沒有資料</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- 分頁導航 -->
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% if products.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ products.previous_page_number }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&currency={{ request.GET.currency }}&group_by={{ request.GET.group_by }}">上一頁</a>
      </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">第 {{ products.number }} 頁 / 共 {{ products.paginator.num_pages }} 頁</span>
      </li>

      {% if products.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ products.next_page_number }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&currency={{ request.GET.currency }}&group_by={{ request.GET.group_by }}">下一頁</a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>

  <!-- 圖表互動幣別切換 -->
<div class="mb-4">
  <label class="form-label">切換幣別圖表</label>
  <select id="currency-selector" class="form-select" style="max-width: 300px;">
  {% for key, value in chart_dict_raw.items %}
    <option value="{{ key }}">{{ key }}</option>
  {% endfor %}
</select>

</div>

<!-- 單一互動圖表畫布 -->
<canvas id="currency-chart" height="100"></canvas>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const chartDict = {{ chart_dict|safe }};
  const groupBy = "{{ request.GET.group_by|default:'month' }}";
  const groupByTextMap = { day: '日', month: '月', year: '年' };
  const groupByText = groupByTextMap[groupBy] || '月';

  const ctx = document.getElementById('currency-chart');
  const currencySelect = document.getElementById('currency-selector');
  let currentChart;

  function renderChart(currency) {
    const dataObj = chartDict[currency];
    if (!dataObj) return;

    const config = {
      type: 'line',
      data: {
        labels: dataObj.labels,
        datasets: [{
          label: `${currency} - 現金買入總和（${groupByText}）`,
          data: dataObj.data,
          borderColor: 'rgba(75, 192, 192, 1)',
          tension: 0.1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          title: { display: false }
        }
      }
    };

    if (currentChart) {
      currentChart.destroy();
    }
    currentChart = new Chart(ctx, config);
  }

  // 初始渲染
  const initialCurrency = currencySelect.value;
  renderChart(initialCurrency);

  // 當幣別切換時更新圖表
  currencySelect.addEventListener('change', function () {
    renderChart(this.value);
  });
</script>

{% endblock %}
